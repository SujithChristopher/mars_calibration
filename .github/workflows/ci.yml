name: CI Build Test

on:
  push:
    branches: [ main, uniform_calibration ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  test-build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Verify required folders exist
      run: |
        if (!(Test-Path "calibration")) { Write-Error "Missing calibration folder"; exit 1 }
        if (!(Test-Path "marsfire")) { Write-Error "Missing marsfire folder"; exit 1 }
        if (!(Test-Path "marsfire\variable.h")) { Write-Error "Missing marsfire\variable.h"; exit 1 }
        if (!(Test-Path "marsfire\marsfire.ino")) { Write-Error "Missing marsfire\marsfire.ino"; exit 1 }
        Write-Host "✓ All required firmware folders present"
      shell: pwsh

    - name: Build executable with PyInstaller
      run: |
        Write-Host "Starting PyInstaller build..."
        pyinstaller mars_calibration.spec
        Write-Host "✓ PyInstaller build completed"
      shell: pwsh

    - name: Verify executable was created
      run: |
        if (!(Test-Path "dist\MarsCalibration\MarsCalibration.exe")) {
          Write-Error "Executable not found at dist\MarsCalibration\MarsCalibration.exe"
          exit 1
        }
        $size = (Get-Item "dist\MarsCalibration\MarsCalibration.exe").Length / 1MB
        Write-Host "✓ Executable created successfully (${size:N2} MB)"
      shell: pwsh

    - name: Verify bundled firmware folders
      run: |
        Write-Host "Checking for bundled firmware folders in _internal..."
        $internalPath = "dist\MarsCalibration\_internal"

        # Check for calibration folder
        if (!(Test-Path "$internalPath\calibration\calibration.ino")) {
          Write-Error "Missing bundled calibration firmware"
          exit 1
        }
        Write-Host "✓ Found calibration/calibration.ino"

        # Check for marsfire folder and all required files
        if (!(Test-Path "$internalPath\marsfire\marsfire.ino")) {
          Write-Error "Missing bundled marsfire/marsfire.ino"
          exit 1
        }
        Write-Host "✓ Found marsfire/marsfire.ino"

        if (!(Test-Path "$internalPath\marsfire\variable.h")) {
          Write-Error "Missing bundled marsfire/variable.h"
          exit 1
        }
        Write-Host "✓ Found marsfire/variable.h"

        # List all marsfire files
        Write-Host "`nMarsfire folder contents:"
        Get-ChildItem "$internalPath\marsfire" | ForEach-Object { Write-Host "  - $($_.Name)" }

        Write-Host "`n✅ All required firmware files are bundled correctly!"
      shell: pwsh

    - name: Test executable startup (smoke test)
      run: |
        Write-Host "Testing executable startup..."
        $process = Start-Process -FilePath "dist\MarsCalibration\MarsCalibration.exe" -PassThru
        Start-Sleep -Seconds 5
        if (!$process.HasExited) {
          Write-Host "✓ Executable started successfully"
          Stop-Process -Id $process.Id -Force
        } else {
          Write-Error "Executable crashed on startup"
          exit 1
        }
      shell: pwsh
      continue-on-error: true

    - name: Upload build artifact for inspection
      uses: actions/upload-artifact@v4
      with:
        name: windows-test-build
        path: dist/MarsCalibration/
        retention-days: 7

  test-build-macos:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Verify required folders exist
      run: |
        echo "Checking for required firmware folders..."
        [ ! -d "calibration" ] && echo "❌ Missing calibration folder" && exit 1
        [ ! -d "marsfire" ] && echo "❌ Missing marsfire folder" && exit 1
        [ ! -f "marsfire/variable.h" ] && echo "❌ Missing marsfire/variable.h" && exit 1
        [ ! -f "marsfire/marsfire.ino" ] && echo "❌ Missing marsfire/marsfire.ino" && exit 1
        echo "✓ All required firmware folders present"

    - name: Build executable with PyInstaller
      run: |
        echo "Starting PyInstaller build..."
        pyinstaller mars_calibration.spec
        echo "✓ PyInstaller build completed"

    - name: Verify executable was created
      run: |
        if [ ! -f "dist/MarsCalibration/MarsCalibration" ]; then
          echo "❌ Executable not found at dist/MarsCalibration/MarsCalibration"
          exit 1
        fi
        size=$(du -h dist/MarsCalibration/MarsCalibration | cut -f1)
        echo "✓ Executable created successfully ($size)"

    - name: Verify bundled firmware folders
      run: |
        echo "Checking for bundled firmware folders..."

        # Check for calibration folder
        if [ ! -f "dist/MarsCalibration/_internal/calibration/calibration.ino" ]; then
          echo "❌ Missing bundled calibration firmware"
          exit 1
        fi
        echo "✓ Found calibration/calibration.ino"

        # Check for marsfire folder
        if [ ! -f "dist/MarsCalibration/_internal/marsfire/marsfire.ino" ]; then
          echo "❌ Missing bundled marsfire/marsfire.ino"
          exit 1
        fi
        echo "✓ Found marsfire/marsfire.ino"

        if [ ! -f "dist/MarsCalibration/_internal/marsfire/variable.h" ]; then
          echo "❌ Missing bundled marsfire/variable.h"
          exit 1
        fi
        echo "✓ Found marsfire/variable.h"

        # List all marsfire files
        echo ""
        echo "Marsfire folder contents:"
        ls -la dist/MarsCalibration/_internal/marsfire/

        echo ""
        echo "✅ All required firmware files are bundled correctly!"

    - name: Upload build artifact for inspection
      uses: actions/upload-artifact@v4
      with:
        name: macos-test-build
        path: dist/MarsCalibration/
        retention-days: 7

  summary:
    needs: [test-build-windows, test-build-macos]
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Build Summary
      run: |
        echo "# CI Build Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "✅ Build test completed successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "All required firmware folders are properly bundled:" >> $GITHUB_STEP_SUMMARY
        echo "- calibration/ (unified calibration program)" >> $GITHUB_STEP_SUMMARY
        echo "- marsfire/ (production firmware with variable.h)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Ready for release when you create a version tag!" >> $GITHUB_STEP_SUMMARY
