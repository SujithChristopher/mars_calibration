name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write  # Required to create releases
  
jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Build executable with PyInstaller
      run: |
        pyinstaller mars_calibration.spec

    - name: Verify build (onedir mode)
      run: |
        if (!(Test-Path "dist\MarsCalibration\MarsCalibration.exe")) {
          Write-Error "Build failed - executable not found"
          exit 1
        }
        if (!(Test-Path "dist\MarsCalibration\_internal\calibration\calibration.ino")) {
          Write-Error "Build failed - calibration firmware not bundled"
          exit 1
        }
        if (!(Test-Path "dist\MarsCalibration\_internal\marsfire\marsfire.ino")) {
          Write-Error "Build failed - marsfire firmware not bundled"
          exit 1
        }
        Write-Host "✓ Build verification passed"
      shell: pwsh

    - name: Test executable (basic smoke test)
      run: |
        Write-Host "Testing executable startup..."
        $process = Start-Process -FilePath "dist\MarsCalibration\MarsCalibration.exe" -PassThru
        Start-Sleep -Seconds 5
        if (!$process.HasExited) {
          Write-Host "✓ Executable started successfully"
          Stop-Process -Id $process.Id -Force
        } else {
          Write-Warning "Executable exited during smoke test"
        }
      shell: pwsh
      continue-on-error: true

    - name: Create release archive
      run: |
        # Copy entire MarsCalibration folder (onedir mode)
        Copy-Item -Path "dist\MarsCalibration" -Destination "MarsCalibration-Windows" -Recurse

        # Add README and requirements to the package
        Copy-Item "README.md" -Destination "MarsCalibration-Windows\"
        Copy-Item "requirements.txt" -Destination "MarsCalibration-Windows\"

        # Create ZIP archive
        Compress-Archive -Path "MarsCalibration-Windows" -DestinationPath "MarsCalibration-Windows-x64.zip"
      shell: pwsh
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-executable
        path: MarsCalibration-Windows-x64.zip
        retention-days: 90


  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Build executable with PyInstaller
      run: |
        pyinstaller mars_calibration.spec

    - name: Verify build (onedir mode)
      run: |
        if [ ! -f "dist/MarsCalibration/MarsCalibration" ]; then
          echo "❌ Build failed - executable not found"
          exit 1
        fi
        if [ ! -f "dist/MarsCalibration/_internal/calibration/calibration.ino" ]; then
          echo "❌ Build failed - calibration firmware not bundled"
          exit 1
        fi
        if [ ! -f "dist/MarsCalibration/_internal/marsfire/marsfire.ino" ]; then
          echo "❌ Build failed - marsfire firmware not bundled"
          exit 1
        fi
        echo "✓ Build verification passed"

    - name: Create release archive
      run: |
        # Copy entire MarsCalibration folder (onedir mode)
        cp -r dist/MarsCalibration MarsCalibration-macOS

        # Add README and requirements to the package
        cp README.md MarsCalibration-macOS/
        cp requirements.txt MarsCalibration-macOS/

        # Create tar.gz archive
        tar -czf MarsCalibration-macOS-x64.tar.gz MarsCalibration-macOS
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-executable
        path: MarsCalibration-macOS-x64.tar.gz
        retention-days: 90

  create-release:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          windows-executable/MarsCalibration-Windows-x64.zip
          macos-executable/MarsCalibration-macOS-x64.tar.gz
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}